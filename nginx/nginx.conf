events {}

http {
    server {
        listen 80;
        server_name ${DOMAIN_NAME};

        location /.well-known/acme-challenge/ { root /var/www/certbot; }
        location / { return 301 https://$host$request_uri; }
    }

    server {
        listen 443 ssl http2;
        server_name ${DOMAIN_NAME};

        ssl_certificate /etc/letsencrypt/live/${DOMAIN_NAME}/fullchain.pem;
        ssl_certificate_key /etc/letsencrypt/live/${DOMAIN_NAME}/privkey.pem;

        # Gitea
        location / { proxy_pass http://gitea:3000; proxy_set_header Host $host; }

        # Backend API
        location /api/ { proxy_pass http://backend:5000/; }

        # Frontend
        location /app/ { alias /usr/share/nginx/html/; try_files $uri $uri/ /app/index.html; }
        location / { proxy_pass http://frontend:5173; }
    }
}
