services:
  backend:
    build: ./backend
    container_name: marine-backend
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - NODE_ENV=production
      - TRANSLATIONS_REPO=translations-data
      - TRANSLATIONS_REPO_PATH=/app/translations-data
      - SQLITE_DB_PATH=/app/backend/data/translations.db
    volumes:
      - ./backend/data:/app/backend/data
      - ./data:/data
    ports:
      - "5000:5000"

  frontend:
    build: 
      context: ./frontend
      args:
        - VITE_API_URL=${VITE_API_URL:-http://localhost:5000/api}
        - VITE_DOMAIN=${DOMAIN:-localhost}
    container_name: marine-frontend
    restart: unless-stopped
    environment:
      - VITE_API_URL=${VITE_API_URL:-http://localhost:5000/api}
    ports:
      - "4173:4173"
    depends_on:
      - backend

  graphdb:
    image: ghcr.io/vliz-be-opsci/kgap/kgap_graphdb:latest
    container_name: marine_graphdb
    env_file:
      - ./.env
    environment:
      - GDB_JAVA_OPTS=-Xms8g -Xmx16g -Dcom.ontotext.graphdb.monitoring.jmx=true
      # GDB_REPO: kgap
      # GDB_HOME_FOLDER: /opt/graphdb/home/
    ports:
      - 7200:7200 # HTTP
    cpus: 4
    volumes:
      - ./data:/data
      - ./data/graphdb-import:/root/graphdb-import/data

  ldes-consumer:
    image: ghcr.io/vliz-be-opsci/kgap/kgap_ldes-consumer:latest
    container_name: marine_ldes_consumer
    restart: unless-stopped
    volumes:
      - "./data:/data"
      - "/var/run/docker.sock:/var/run/docker.sock" # Required to spawn docker containers
    env_file:
      - ./.env
    environment:
      - DOCKER_NETWORK=${COMPOSE_PROJECT_NAME:-kgap}_default
    depends_on:
      graphdb:
        condition: service_healthy